/* GoBuy Deals & Discovery */

let ALL = [];
let VIEW = [];
let CART = [];
let WISHLIST = [];
let COMPARE = [];
let ORDERS = [];
let state = {
  cat: "all",
  search: "",
  sort: "smart",
  free: false,
  local: false,
  minPrice: 0,
  maxPrice: 500,
  brands: [],
  minRating: 0,
  page: 1,
  pageSize: 15,
};

document.addEventListener("DOMContentLoaded", async () => {
  try {
    const saved = parseInt(localStorage.getItem("pageSize"), 10);
    if (!isNaN(saved) && saved > 0) state.pageSize = saved;
    CART = JSON.parse(localStorage.getItem("cart") || "[]");
    WISHLIST = JSON.parse(localStorage.getItem("wishlist") || "[]");
    COMPARE = JSON.parse(localStorage.getItem("compare") || "[]");
    ORDERS = JSON.parse(localStorage.getItem("orders") || "[]");
  } catch {}
  await load();
  wire();
  wireCartWishlist();
  apply(true);
  updateBadges();
  initPriceSlider();
});

async function load() {
  const base = await fetchProductsFromAPI();
  ALL = base.map(augment);
  VIEW = [...ALL];
  renderHeroDeals();
  renderBanners();
}

function augment(p, idx) {
  const sellers = [
    "ZenMall",
    "NovaDirect",
    "HappyHome EU",
    "UrbanTech",
    "Sportivo NL",
    "KitchenPro",
  ];
  const shipFromList = ["NL", "PL", "ES", "DE", "CN"];
  const rating = +(3.8 + Math.random() * 1.2).toFixed(1);
  const orders = 50 + Math.floor(Math.random() * 18000);
  const freeShip = Math.random() > 0.5;
  const local = Math.random() > 0.6;
  const discount =
    Math.random() > 0.5 ? 10 + Math.floor(Math.random() * 50) : 0;
  const originalPrice = discount
    ? +(p.price * (1 + discount / 100)).toFixed(2)
    : p.price;
  const shipFrom =
    shipFromList[Math.floor(Math.random() * shipFromList.length)];
  return {
    ...p,
    seller: sellers[idx % sellers.length],
    rating,
    orders,
    freeShip,
    local,
    discount,
    originalPrice,
    shipFrom,
    createdAt: Date.now() - Math.floor(Math.random() * 45 * 24 * 3600 * 1000),
  };
}

function wire() {
  document.querySelectorAll(".cat").forEach((btn) => {
    btn.addEventListener("click", () => {
      state.cat = btn.dataset.cat;
      state.page = 1;
      apply(true);
    });
  });
  document.getElementById("search-btn")?.addEventListener("click", () => {
    state.search = document.getElementById("search").value.trim().toLowerCase();
    state.page = 1;
    apply(true);
  });
  document.getElementById("search")?.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      state.search = document
        .getElementById("search")
        .value.trim()
        .toLowerCase();
      state.page = 1;
      apply(true);
    }
  });
  document.getElementById("sort")?.addEventListener("change", (e) => {
    state.sort = e.target.value;
    state.page = 1;
    apply(true);
  });
  const ps = document.getElementById("page-size");
  if (ps) {
    ps.value = String(state.pageSize);
    ps.addEventListener("change", () => {
      state.pageSize = parseInt(ps.value, 10) || 15;
      localStorage.setItem("pageSize", String(state.pageSize));
      state.page = 1;
      apply(true);
    });
  }
  document.getElementById("flt-free")?.addEventListener("change", (e) => {
    state.free = !!e.target.checked;
    state.page = 1;
    apply(true);
  });
  document.getElementById("flt-local")?.addEventListener("change", (e) => {
    state.local = !!e.target.checked;
    state.page = 1;
    apply(true);
  });
  document.getElementById("rating-select")?.addEventListener("change", (e) => {
    state.minRating = parseFloat(e.target.value) || 0;
    state.page = 1;
    apply(true);
  });
  document.getElementById("brand-select")?.addEventListener("change", (e) => {
    const options = Array.from(e.target.selectedOptions);
    state.brands = options.map((o) => o.value).filter((v) => v !== "");
    state.page = 1;
    apply(true);
  });
  document
    .getElementById("compare-btn")
    ?.addEventListener("click", openCompare);
}

function apply(scroll) {
  VIEW = filterBase();
  sortData(VIEW);
  renderGrid();
  renderPagination();
  if (scroll)
    document.querySelector(".grid")?.scrollIntoView({ behavior: "smooth" });
}

function filterBase() {
  let data = [...ALL];
  if (state.cat !== "all") data = data.filter((p) => p.type === state.cat);
  if (state.search)
    data = data.filter(
      (p) =>
        p.name.toLowerCase().includes(state.search) ||
        p.description.toLowerCase().includes(state.search)
    );
  if (state.free) data = data.filter((p) => p.freeShip);
  if (state.local) data = data.filter((p) => p.local);

  // Price filter
  data = data.filter((p) => {
    const price = p.price * 1.21;
    return price >= state.minPrice && price <= state.maxPrice;
  });

  // Brand filter
  if (state.brands.length > 0) {
    data = data.filter((p) => state.brands.includes(p.seller));
  }

  // Rating filter
  if (state.minRating > 0) {
    data = data.filter((p) => p.rating >= state.minRating);
  }

  return data;
}

function sortData(list) {
  const k = state.sort;
  if (k === "price-asc") list.sort((a, b) => a.price - b.price);
  else if (k === "price-desc") list.sort((a, b) => b.price - a.price);
  else if (k === "popular") list.sort((a, b) => b.orders - a.orders);
  else if (k === "new") list.sort((a, b) => b.createdAt - a.createdAt);
  else if (k === "smart")
    list.sort((a, b) => b.discount - a.discount || b.orders - a.orders);
}

function renderHeroDeals() {
  const wrap = document.getElementById("hero-deals");
  if (!wrap) return;
  const picks = [...ALL]
    .sort((a, b) => b.discount - a.discount || b.orders - a.orders)
    .slice(0, 8);
  wrap.innerHTML = "";
  picks.forEach((p) => {
    const price = `‚Ç¨${(p.price * 1.21).toFixed(2)}`;
    const original = p.discount
      ? `‚Ç¨${(p.originalPrice * 1.21).toFixed(2)}`
      : "";
    const el = document.createElement("div");
    el.className = "deal";
    el.style.cursor = "pointer";
    el.innerHTML = `
      <img src="${p.image}" alt="${
      p.name
    }" loading="lazy" onerror="this.src='https://via.placeholder.com/400x300/f3f3f3/666666?text=Deal'">
      <div class="body">
        <div class="title">${p.name}</div>
        <div class="price">${price} ${
      original ? `<small>${original}</small>` : ""
    }</div>
      </div>`;
    el.addEventListener("click", () => openProductModal(p));
    wrap.appendChild(el);
  });
}

function renderBanners() {
  const b1 = document.getElementById("banner-1");
  const b2 = document.getElementById("banner-2");
  if (b1)
    b1.innerHTML =
      '<div style="display:grid;place-items:center;height:100%">Weekend Mega Deals</div>';
  if (b2)
    b2.innerHTML =
      '<div style="display:grid;place-items:center;height:100%">NL-only snellere verzending</div>';
}

function renderGrid() {
  const grid = document.getElementById("grid");
  if (!grid) return;
  grid.innerHTML = "";
  const start = (state.page - 1) * state.pageSize;
  const end = start + state.pageSize;
  const pageItems = VIEW.slice(start, end);
  if (!pageItems.length) {
    grid.innerHTML = '<div class="empty">Geen producten gevonden.</div>';
    return;
  }
  pageItems.forEach((p) => grid.appendChild(card(p)));
}

function card(p) {
  const el = document.createElement("div");
  el.className = "card";
  const price = (p.price * 1.21).toFixed(2);
  const original = p.discount ? (p.originalPrice * 1.21).toFixed(2) : "";
  const stars =
    "‚òÖ".repeat(Math.round(p.rating)) + "‚òÜ".repeat(5 - Math.round(p.rating));
  const isWished = WISHLIST.some((w) => w.id === p.id);
  const isCompared = COMPARE.some((c) => c.id === p.id);
  el.innerHTML = `
    <img class="thumb" src="${p.image}" alt="${
    p.name
  }" loading="lazy" onerror="this.src='https://via.placeholder.com/400x400/f3f3f3/666666?text=No+Image'" />
    <div class="body">
      <div class="title">${p.name}</div>
      <div class="meta"><span>${stars}</span><span>${p.rating.toFixed(
    1
  )}</span><span>¬∑ ${p.orders} orders</span></div>
      <div><span class="price">‚Ç¨${price}</span> ${
    original ? `<small>‚Ç¨${original}</small>` : ""
  } ${p.freeShip ? '<span class="badge">Gratis verzending</span>' : ""}</div>
      <div class="seller">${p.seller} ¬∑ Verzending uit ${p.shipFrom}</div>
      <div class="actions">
        <button class="btn primary cart-add" data-id="${p.id}">üõí</button>
        <button class="btn wish-toggle ${isWished ? "active" : ""}" data-id="${
    p.id
  }">${isWished ? "‚ù§Ô∏è" : "‚ô°"}</button>
        <button class="btn compare-toggle ${
          isCompared ? "active" : ""
        }" data-id="${p.id}" title="Vergelijken">‚öñÔ∏è</button>
      </div>
    </div>`;
  el.querySelector(".thumb").addEventListener("click", () =>
    openProductModal(p)
  );
  el.querySelector(".title").addEventListener("click", () =>
    openProductModal(p)
  );
  el.querySelector(".cart-add").addEventListener("click", (e) => {
    e.stopPropagation();
    addToCart(p);
  });
  el.querySelector(".wish-toggle").addEventListener("click", (e) => {
    e.stopPropagation();
    toggleWishlist(p);
  });
  el.querySelector(".compare-toggle").addEventListener("click", (e) => {
    e.stopPropagation();
    toggleCompare(p);
  });
  return el;
}

function renderPagination() {
  const total = VIEW.length;
  const totalPages = Math.max(1, Math.ceil(total / state.pageSize));
  state.page = Math.min(state.page, totalPages);
  const info = document.querySelector(".pagination .info");
  const prev = document.querySelector(".pagination .prev");
  const next = document.querySelector(".pagination .next");
  const first = document.querySelector(".pagination .first");
  const last = document.querySelector(".pagination .last");
  const nums = document.querySelector(".pagination .numbers");
  if (info) info.textContent = `Pagina ${state.page}/${totalPages}`;
  const scroll = () =>
    document.querySelector(".grid")?.scrollIntoView({ behavior: "smooth" });
  if (prev) {
    prev.disabled = state.page <= 1;
    prev.onclick = () => {
      if (state.page > 1) {
        state.page--;
        renderGrid();
        renderPagination();
        scroll();
      }
    };
  }
  if (next) {
    next.disabled = state.page >= totalPages;
    next.onclick = () => {
      if (state.page < totalPages) {
        state.page++;
        renderGrid();
        renderPagination();
        scroll();
      }
    };
  }
  if (first) {
    first.disabled = state.page <= 1;
    first.onclick = () => {
      if (state.page !== 1) {
        state.page = 1;
        renderGrid();
        renderPagination();
        scroll();
      }
    };
  }
  if (last) {
    last.disabled = state.page >= totalPages;
    last.onclick = () => {
      if (state.page !== totalPages) {
        state.page = totalPages;
        renderGrid();
        renderPagination();
        scroll();
      }
    };
  }
  if (nums) {
    nums.innerHTML = "";
    const windowSize = 5;
    let start = Math.max(1, state.page - 2);
    let end = Math.min(totalPages, start + windowSize - 1);
    if (end - start < windowSize - 1) start = Math.max(1, end - windowSize + 1);
    for (let i = start; i <= end; i++) {
      const b = document.createElement("button");
      b.textContent = String(i);
      if (i === state.page) b.classList.add("active");
      b.onclick = () => {
        if (state.page !== i) {
          state.page = i;
          renderGrid();
          renderPagination();
          scroll();
        }
      };
      nums.appendChild(b);
    }
  }
}

function wireCartWishlist() {
  document
    .querySelector(".actions .act:nth-child(3)")
    ?.addEventListener("click", openCart);
  document
    .querySelector(".actions .act:nth-child(1)")
    ?.addEventListener("click", openWishlist);
  const modal = document.getElementById("product-modal");
  modal?.addEventListener("click", (e) => {
    if (e.target === modal) closeModal();
  });
}

function addToCart(p) {
  CART.push(p);
  localStorage.setItem("cart", JSON.stringify(CART));
  updateBadges();
  showToast(`${p.name} toegevoegd aan winkelwagen`);
}

function toggleWishlist(p) {
  const idx = WISHLIST.findIndex((w) => w.id === p.id);
  if (idx > -1) {
    WISHLIST.splice(idx, 1);
    showToast(`${p.name} verwijderd uit wishlist`);
  } else {
    WISHLIST.push(p);
    showToast(`${p.name} toegevoegd aan wishlist`);
  }
  localStorage.setItem("wishlist", JSON.stringify(WISHLIST));
  updateBadges();
  renderGrid();
}

function updateBadges() {
  const cartBadge = document.querySelector(".actions .act:nth-child(3) .badge");
  const wishBadge = document.querySelector(".actions .act:nth-child(1) .badge");
  if (cartBadge) cartBadge.textContent = CART.length;
  if (wishBadge) wishBadge.textContent = WISHLIST.length;
  updateCompareBadge();
}

function openCart() {
  const modal = document.getElementById("product-modal");
  if (!modal) return;
  const total = CART.reduce((sum, p) => sum + p.price * 1.21, 0).toFixed(2);
  modal.innerHTML = `
    <div class="content">
      <div class="header">
        <h2>üõí Winkelwagen</h2>
        <button class="close" onclick="closeModal()">‚úï</button>
      </div>
      <div class="body" style="display:block;max-height:400px;overflow-y:auto">
        ${
          CART.length
            ? CART.map(
                (p, i) => `
          <div style="display:flex;gap:12px;align-items:center;padding:12px;border-bottom:1px solid var(--border)">
            <img src="${
              p.image
            }" style="width:60px;height:60px;object-fit:cover;border-radius:8px" loading="lazy" onerror="this.src='https://via.placeholder.com/60x60/f3f3f3/666?text=?'" />
            <div style="flex:1">
              <div style="font-weight:600">${p.name}</div>
              <div style="color:var(--muted);font-size:13px">‚Ç¨${(
                p.price * 1.21
              ).toFixed(2)}</div>
            </div>
            <button class="btn" onclick="removeFromCart(${i})" style="padding:4px 8px">‚úï</button>
          </div>
        `
              ).join("")
            : '<div style="padding:24px;text-align:center;color:var(--muted)">Je winkelwagen is leeg</div>'
        }
      </div>
      <div style="padding:16px;border-top:2px solid var(--border)">
        <div style="display:flex;justify-content:space-between;font-size:18px;font-weight:700;margin-bottom:12px">
          <span>Totaal</span>
          <span>‚Ç¨${total}</span>
        </div>
        <button class="btn primary" id="checkout-button" style="width:100%;padding:12px" ${
          CART.length ? "" : "disabled"
        }>üí≥ Afrekenen</button>
      </div>
    </div>`;

  document.getElementById("checkout-button")?.addEventListener("click", () => {
    closeModal();
    setTimeout(() => openCheckout(), 300);
  });

  modal.classList.remove("hidden");
}

function openWishlist() {
  const modal = document.getElementById("product-modal");
  if (!modal) return;
  modal.innerHTML = `
    <div class="content">
      <div class="header">
        <h2>‚ù§ Wishlist</h2>
        <button class="close" onclick="closeModal()">‚úï</button>
      </div>
      <div class="body" style="display:block;max-height:400px;overflow-y:auto">
        ${
          WISHLIST.length
            ? WISHLIST.map(
                (p, i) => `
          <div style="display:flex;gap:12px;align-items:center;padding:12px;border-bottom:1px solid var(--border)">
            <img src="${
              p.image
            }" style="width:60px;height:60px;object-fit:cover;border-radius:8px" loading="lazy" onerror="this.src='https://via.placeholder.com/60x60/f3f3f3/666?text=?'" />
            <div style="flex:1">
              <div style="font-weight:600">${p.name}</div>
              <div style="color:var(--muted);font-size:13px">‚Ç¨${(
                p.price * 1.21
              ).toFixed(2)}</div>
            </div>
            <button class="btn primary" onclick="addToCartFromWishlist(${i})" style="padding:4px 8px">üõí</button>
            <button class="btn" onclick="removeFromWishlist(${i})" style="padding:4px 8px">‚úï</button>
          </div>
        `
              ).join("")
            : '<div style="padding:24px;text-align:center;color:var(--muted)">Je wishlist is leeg</div>'
        }
      </div>
    </div>`;
  modal.classList.remove("hidden");
}

function removeFromCart(idx) {
  CART.splice(idx, 1);
  localStorage.setItem("cart", JSON.stringify(CART));
  updateBadges();
  openCart();
}

function removeFromWishlist(idx) {
  WISHLIST.splice(idx, 1);
  localStorage.setItem("wishlist", JSON.stringify(WISHLIST));
  updateBadges();
  renderGrid();
  openWishlist();
}

function addToCartFromWishlist(idx) {
  const p = WISHLIST[idx];
  addToCart(p);
}

function openProductModal(p) {
  const modal = document.getElementById("product-modal");
  if (!modal) return;
  const price = (p.price * 1.21).toFixed(2);
  const original = p.discount ? (p.originalPrice * 1.21).toFixed(2) : "";
  const stars =
    "‚òÖ".repeat(Math.round(p.rating)) + "‚òÜ".repeat(5 - Math.round(p.rating));
  const reviews = generateReviews(p);
  const related = ALL.filter((x) => x.type === p.type && x.id !== p.id).slice(
    0,
    4
  );

  modal.innerHTML = `
    <div class="content" style="max-width:900px">
      <div class="header">
        <h2>${p.name}</h2>
        <button class="close" onclick="closeModal()">‚úï</button>
      </div>
      <div class="body" style="display:grid;grid-template-columns:1fr 1fr;gap:24px">
        <div>
          <img src="${
            p.image
          }" style="width:100%;height:320px;object-fit:cover;border-radius:12px;background:#f3f3f3" loading="lazy" onerror="this.src='https://via.placeholder.com/600x400/f3f3f3/666?text=No+Image'" />
          <div style="margin-top:16px">
            <h3 style="margin-bottom:8px">Product details</h3>
            <ul style="padding-left:20px;color:var(--muted);line-height:1.8">
              ${p.features.map((f) => `<li>${f}</li>`).join("")}
            </ul>
          </div>
        </div>
        <div>
          <div style="margin-bottom:16px">
            <div style="font-size:28px;font-weight:700;color:var(--primary)">‚Ç¨${price}</div>
            ${
              original
                ? `<div style="color:var(--muted);text-decoration:line-through">‚Ç¨${original}</div>`
                : ""
            }
            ${
              p.discount
                ? `<div style="color:var(--accent);font-weight:600">-${p.discount}% korting</div>`
                : ""
            }
          </div>
          <div style="margin-bottom:16px">
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
              <span style="font-size:20px">${stars}</span>
              <span style="font-weight:600">${p.rating.toFixed(1)}</span>
              <span style="color:var(--muted)">(${
                reviews.length
              } reviews)</span>
            </div>
            <div style="color:var(--muted);font-size:14px">${
              p.orders
            }+ bestellingen ¬∑ ${p.seller}</div>
            ${
              p.freeShip
                ? '<div style="color:var(--accent);font-weight:600;margin-top:4px">‚úì Gratis verzending</div>'
                : ""
            }
            ${
              p.local
                ? '<div style="color:var(--accent);font-weight:600">‚úì Lokaal magazijn</div>'
                : ""
            }
          </div>
          <div style="margin-bottom:16px">
            <p style="line-height:1.6;color:var(--text)">${p.description}</p>
          </div>
          <div style="display:flex;gap:12px;margin-bottom:24px">
            <button class="btn primary" onclick="addToCartFromModal('${
              p.id
            }')" style="flex:1;padding:12px">üõí In winkelwagen</button>
            <button class="btn" onclick="toggleWishlistFromModal('${
              p.id
            }')" style="padding:12px">${
    WISHLIST.some((w) => w.id === p.id) ? "‚ù§" : "‚ô°"
  }</button>
          </div>
          <div style="border-top:1px solid var(--border);padding-top:16px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <h4 style="margin:0">Reviews (${reviews.length})</h4>
              <button class="btn primary" onclick="openReviewForm('${
                p.id
              }')" style="padding:6px 12px;font-size:13px">
                ‚úçÔ∏è Schrijf review
              </button>
            </div>
            <div style="max-height:200px;overflow-y:auto">
              ${reviews
                .map(
                  (r) => `
                <div style="margin-bottom:12px;padding:8px;background:var(--bg);border-radius:8px">
                  <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                    <span style="font-weight:600">${r.name}</span>
                    <span style="color:var(--accent)">${"‚òÖ".repeat(
                      r.rating
                    )}</span>
                  </div>
                  <div style="font-size:13px;color:var(--muted)">${r.text}</div>
                </div>
              `
                )
                .join("")}
              ${getUserReviews(p.id)
                .map(
                  (r) => `
                <div style="margin-bottom:12px;padding:8px;background:#e8f5e9;border:1px solid #4caf50;border-radius:8px">
                  <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                    <span style="font-weight:600">${
                      r.name
                    } <span style="color:#4caf50;font-size:11px">‚úì Jouw review</span></span>
                    <span style="color:var(--accent)">${"‚òÖ".repeat(
                      r.rating
                    )}</span>
                  </div>
                  <div style="font-size:13px;color:var(--text)">${r.text}</div>
                  <div style="font-size:11px;color:var(--muted);margin-top:4px">${
                    r.date
                  }</div>
                </div>
              `
                )
                .join("")}
            </div>
          </div>
          ${
            related.length
              ? `
            <div style="border-top:1px solid var(--border);padding-top:16px;margin-top:16px">
              <h4 style="margin-bottom:12px">Ook interessant</h4>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                ${related
                  .map(
                    (r) => `
                  <div onclick="openProductModal(ALL.find(p=>p.id==='${
                    r.id
                  }'))" style="cursor:pointer;border:1px solid var(--border);border-radius:8px;padding:8px;display:flex;gap:8px;align-items:center">
                    <img src="${
                      r.image
                    }" style="width:50px;height:50px;object-fit:cover;border-radius:6px" loading="lazy" onerror="this.src='https://via.placeholder.com/50x50/f3f3f3/666?text=?'" />
                    <div style="flex:1;font-size:12px">
                      <div style="font-weight:600">${r.name.substring(
                        0,
                        30
                      )}...</div>
                      <div style="color:var(--primary)">‚Ç¨${(
                        r.price * 1.21
                      ).toFixed(2)}</div>
                    </div>
                  </div>
                `
                  )
                  .join("")}
              </div>
            </div>
          `
              : ""
          }
        </div>
      </div>
    </div>`;
  modal.classList.remove("hidden");
}

function addToCartFromModal(id) {
  const p = ALL.find((x) => x.id === id);
  if (p) addToCart(p);
}

function toggleWishlistFromModal(id) {
  const p = ALL.find((x) => x.id === id);
  if (p) {
    toggleWishlist(p);
    openProductModal(p);
  }
}

function closeModal() {
  document.getElementById("product-modal")?.classList.add("hidden");
}

function generateReviews(p) {
  const names = ["Emma", "Lars", "Sophie", "Daan", "Lisa", "Tim"];
  const texts = [
    "Super blij mee! Precies wat ik zocht.",
    "Goede kwaliteit voor de prijs.",
    "Snelle levering en goed verpakt.",
    "Werkt perfect, aanrader!",
    "Precies zoals beschreven.",
  ];
  const count = Math.min(5, Math.floor(p.orders / 200) + 2);
  return Array.from({ length: count }, (_, i) => ({
    name: names[i % names.length],
    rating: Math.max(3, Math.round(p.rating)),
    text: texts[i % texts.length],
  }));
}

function showToast(msg) {
  const toast = document.getElementById("toast");
  if (!toast) return;
  toast.textContent = msg;
  toast.classList.add("visible");
  setTimeout(() => toast.classList.remove("visible"), 2500);
}
// Price Slider
function initPriceSlider() {
  const minSlider = document.getElementById("price-slider-min");
  const maxSlider = document.getElementById("price-slider-max");
  const minLabel = document.getElementById("price-min");
  const maxLabel = document.getElementById("price-max");

  if (!minSlider || !maxSlider) return;

  minSlider.addEventListener("input", () => {
    state.minPrice = parseInt(minSlider.value, 10);
    if (state.minPrice > state.maxPrice - 10) {
      state.minPrice = state.maxPrice - 10;
      minSlider.value = state.minPrice;
    }
    if (minLabel) minLabel.textContent = state.minPrice;
    state.page = 1;
    apply(false);
  });

  maxSlider.addEventListener("input", () => {
    state.maxPrice = parseInt(maxSlider.value, 10);
    if (state.maxPrice < state.minPrice + 10) {
      state.maxPrice = state.minPrice + 10;
      maxSlider.value = state.maxPrice;
    }
    if (maxLabel) maxLabel.textContent = state.maxPrice;
    state.page = 1;
    apply(false);
  });

  // Populate brand filter
  populateBrandFilter();
}

function populateBrandFilter() {
  const brandSelect = document.getElementById("brand-select");
  if (!brandSelect) return;

  const brands = [...new Set(ALL.map((p) => p.seller))].sort();
  brands.forEach((brand) => {
    const option = document.createElement("option");
    option.value = brand;
    option.textContent = brand;
    brandSelect.appendChild(option);
  });
}

// Compare System
function toggleCompare(p) {
  const idx = COMPARE.findIndex((c) => c.id === p.id);
  if (idx > -1) {
    COMPARE.splice(idx, 1);
    showToast(`${p.name} verwijderd uit vergelijking`);
  } else {
    if (COMPARE.length >= 4) {
      showToast("Maximaal 4 producten vergelijken");
      return;
    }
    COMPARE.push(p);
    showToast(`${p.name} toegevoegd aan vergelijking`);
  }
  localStorage.setItem("compare", JSON.stringify(COMPARE));
  updateCompareBadge();
  renderGrid();
}

function updateCompareBadge() {
  const badge = document.getElementById("compare-count");
  if (badge) badge.textContent = COMPARE.length;
}

function openCompare() {
  if (COMPARE.length === 0) {
    showToast("Selecteer producten om te vergelijken");
    return;
  }

  const modal = document.getElementById("product-modal");
  if (!modal) return;

  modal.innerHTML = `
    <div class="content" style="max-width:1200px">
      <div class="header">
        <h2>üîç Product vergelijking (${COMPARE.length})</h2>
        <button class="close" onclick="closeModal()">‚úï</button>
      </div>
      <div class="body" style="overflow-x:auto">
        <table class="compare-table">
          <thead>
            <tr>
              <th>Product</th>
              ${COMPARE.map(
                (p) => `
                <th>
                  <img src="${p.image}" style="width:100px;height:100px;object-fit:cover;border-radius:8px" />
                  <div style="margin-top:8px;font-weight:600">${p.name}</div>
                </th>
              `
              ).join("")}
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Prijs</strong></td>
              ${COMPARE.map(
                (p) => `<td>‚Ç¨${(p.price * 1.21).toFixed(2)}</td>`
              ).join("")}
            </tr>
            <tr>
              <td><strong>Rating</strong></td>
              ${COMPARE.map(
                (p) =>
                  `<td>${"‚òÖ".repeat(Math.round(p.rating))} ${p.rating.toFixed(
                    1
                  )}</td>`
              ).join("")}
            </tr>
            <tr>
              <td><strong>Orders</strong></td>
              ${COMPARE.map((p) => `<td>${p.orders}+</td>`).join("")}
            </tr>
            <tr>
              <td><strong>Verkoper</strong></td>
              ${COMPARE.map((p) => `<td>${p.seller}</td>`).join("")}
            </tr>
            <tr>
              <td><strong>Verzending</strong></td>
              ${COMPARE.map(
                (p) => `<td>${p.freeShip ? "‚úì Gratis" : "Betaald"}</td>`
              ).join("")}
            </tr>
            <tr>
              <td><strong>Lokaal</strong></td>
              ${COMPARE.map((p) => `<td>${p.local ? "‚úì Ja" : "Nee"}</td>`).join(
                ""
              )}
            </tr>
            <tr>
              <td><strong>Korting</strong></td>
              ${COMPARE.map(
                (p) => `<td>${p.discount ? `-${p.discount}%` : "Geen"}</td>`
              ).join("")}
            </tr>
            <tr>
              <td><strong>Features</strong></td>
              ${COMPARE.map(
                (p) =>
                  `<td><ul style="padding-left:20px;text-align:left">${p.features
                    .map((f) => `<li>${f}</li>`)
                    .join("")}</ul></td>`
              ).join("")}
            </tr>
            <tr>
              <td><strong>Acties</strong></td>
              ${COMPARE.map(
                (p, i) => `
                <td>
                  <button class="btn primary" onclick="addToCartFromCompare(${i})" style="margin:4px;width:100%">üõí In winkelwagen</button>
                  <button class="btn" onclick="removeFromCompare(${i})" style="margin:4px;width:100%">‚úï Verwijder</button>
                </td>
              `
              ).join("")}
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");
}

function addToCartFromCompare(idx) {
  const p = COMPARE[idx];
  if (p) addToCart(p);
}

function removeFromCompare(idx) {
  COMPARE.splice(idx, 1);
  localStorage.setItem("compare", JSON.stringify(COMPARE));
  updateCompareBadge();
  renderGrid();
  openCompare();
}

// Checkout System
function openCheckout() {
  if (CART.length === 0) {
    showToast("Je winkelwagen is leeg");
    return;
  }

  const modal = document.getElementById("product-modal");
  if (!modal) return;

  const total = CART.reduce((sum, p) => sum + p.price * 1.21, 0).toFixed(2);
  const shipping = CART.every((p) => p.freeShip) ? 0 : 5.95;
  const finalTotal = (parseFloat(total) + shipping).toFixed(2);

  modal.innerHTML = `
    <div class="content" style="max-width:700px">
      <div class="header">
        <h2>‚úÖ Afrekenen</h2>
        <button class="close" onclick="closeModal()">‚úï</button>
      </div>
      <div class="body" style="display:block">
        <form id="checkout-form" style="display:grid;gap:16px">
          <div>
            <h3>Contactgegevens</h3>
            <input type="text" id="checkout-name" placeholder="Volledige naam *" required style="width:100%;padding:10px;margin:4px 0;border:1px solid var(--border);border-radius:8px" />
            <input type="email" id="checkout-email" placeholder="E-mail *" required style="width:100%;padding:10px;margin:4px 0;border:1px solid var(--border);border-radius:8px" />
            <input type="tel" id="checkout-phone" placeholder="Telefoonnummer *" required style="width:100%;padding:10px;margin:4px 0;border:1px solid var(--border);border-radius:8px" />
          </div>
          <div>
            <h3>Verzendadres</h3>
            <input type="text" id="checkout-address" placeholder="Straat + Huisnummer *" required style="width:100%;padding:10px;margin:4px 0;border:1px solid var(--border);border-radius:8px" />
            <input type="text" id="checkout-city" placeholder="Plaats *" required style="width:100%;padding:10px;margin:4px 0;border:1px solid var(--border);border-radius:8px" />
            <input type="text" id="checkout-zip" placeholder="Postcode *" required pattern="[0-9]{4}[A-Za-z]{2}" style="width:100%;padding:10px;margin:4px 0;border:1px solid var(--border);border-radius:8px" />
          </div>
          <div>
            <h3>Bestelling (${CART.length} items)</h3>
            <div style="max-height:200px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;padding:12px">
              ${CART.map(
                (p) => `
                <div style="display:flex;gap:12px;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border)">
                  <img src="${
                    p.image
                  }" style="width:50px;height:50px;object-fit:cover;border-radius:6px" />
                  <div style="flex:1">
                    <div style="font-weight:600;font-size:14px">${p.name}</div>
                    <div style="color:var(--muted);font-size:13px">‚Ç¨${(
                      p.price * 1.21
                    ).toFixed(2)}</div>
                  </div>
                </div>
              `
              ).join("")}
            </div>
            <div style="margin-top:12px;padding:12px;background:var(--bg);border-radius:8px">
              <div style="display:flex;justify-content:space-between;margin:4px 0">
                <span>Subtotaal:</span>
                <span>‚Ç¨${total}</span>
              </div>
              <div style="display:flex;justify-content:space-between;margin:4px 0">
                <span>Verzending:</span>
                <span>${
                  shipping === 0 ? "Gratis" : "‚Ç¨" + shipping.toFixed(2)
                }</span>
              </div>
              <div style="display:flex;justify-content:space-between;margin:8px 0 0;padding-top:8px;border-top:2px solid var(--border);font-size:18px;font-weight:700">
                <span>Totaal:</span>
                <span>‚Ç¨${finalTotal}</span>
              </div>
            </div>
          </div>
          <button type="submit" class="btn primary" style="width:100%;padding:14px;font-size:16px">
            üí≥ Bestelling plaatsen (‚Ç¨${finalTotal})
          </button>
        </form>
      </div>
    </div>
  `;

  document.getElementById("checkout-form")?.addEventListener("submit", (e) => {
    e.preventDefault();
    processOrder();
  });

  modal.classList.remove("hidden");
}

function processOrder() {
  const order = {
    id: Date.now(),
    date: new Date().toLocaleDateString("nl-NL"),
    items: [...CART],
    customer: {
      name: document.getElementById("checkout-name")?.value,
      email: document.getElementById("checkout-email")?.value,
      phone: document.getElementById("checkout-phone")?.value,
      address: document.getElementById("checkout-address")?.value,
      city: document.getElementById("checkout-city")?.value,
      zip: document.getElementById("checkout-zip")?.value,
    },
    total: CART.reduce((sum, p) => sum + p.price * 1.21, 0),
    status: "verwerkt",
  };

  ORDERS.push(order);
  localStorage.setItem("orders", JSON.stringify(ORDERS));

  // Clear cart
  CART = [];
  localStorage.setItem("cart", JSON.stringify(CART));
  updateBadges();

  showOrderConfirmation(order);
}

function showOrderConfirmation(order) {
  const modal = document.getElementById("product-modal");
  if (!modal) return;

  const shipping = order.items.every((p) => p.freeShip) ? 0 : 5.95;
  const finalTotal = (order.total + shipping).toFixed(2);

  modal.innerHTML = `
    <div class="content" style="max-width:600px">
      <div class="header" style="background:var(--accent);color:#fff;padding:24px;border-radius:12px 12px 0 0">
        <h2 style="margin:0;color:#fff">‚úÖ Bestelling geplaatst!</h2>
      </div>
      <div class="body" style="display:block;padding:24px;text-align:center">
        <div style="font-size:48px;margin:16px 0">üéâ</div>
        <h3>Bedankt voor je bestelling!</h3>
        <p style="color:var(--muted)">Bestelnummer: <strong>#${order.id}</strong></p>
        <p>We hebben je bestelling ontvangen en verwerken deze zo snel mogelijk.</p>
        <p>Je ontvangt een bevestigingsmail op <strong>${order.customer.email}</strong></p>
        <div style="margin:24px 0;padding:20px;background:var(--bg);border-radius:12px;text-align:left">
          <h4 style="margin-top:0">Verzendadres:</h4>
          <p style="margin:4px 0">${order.customer.name}</p>
          <p style="margin:4px 0">${order.customer.address}</p>
          <p style="margin:4px 0">${order.customer.zip} ${order.customer.city}</p>
        </div>
        <div style="margin:24px 0;padding:20px;background:var(--bg);border-radius:12px">
          <div style="display:flex;justify-content:space-between;margin:8px 0">
            <span>Aantal producten:</span>
            <strong>${order.items.length}</strong>
          </div>
          <div style="display:flex;justify-content:space-between;margin:8px 0;padding-top:8px;border-top:2px solid var(--border);font-size:18px">
            <span>Totaal betaald:</span>
            <strong style="color:var(--primary)">‚Ç¨${finalTotal}</strong>
          </div>
        </div>
        <button class="btn primary" onclick="closeModal();renderGrid()" style="width:100%;padding:14px;margin-top:16px">
          Terug naar winkelen
        </button>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");
}

// Review Submission System
function openReviewForm(productId) {
  const p = ALL.find((x) => x.id === productId);
  if (!p) return;

  const modal = document.getElementById("product-modal");
  if (!modal) return;

  modal.innerHTML = `
    <div class="content" style="max-width:600px">
      <div class="header">
        <h2>‚úçÔ∏è Review schrijven</h2>
        <button class="close" onclick="closeModal()">‚úï</button>
      </div>
      <div class="body" style="display:block">
        <div style="display:flex;gap:16px;margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid var(--border)">
          <img src="${
            p.image
          }" style="width:80px;height:80px;object-fit:cover;border-radius:8px" />
          <div>
            <h3 style="margin:0 0 8px 0">${p.name}</h3>
            <div style="color:var(--muted)">‚Ç¨${(p.price * 1.21).toFixed(
              2
            )}</div>
          </div>
        </div>
        <form id="review-form" style="display:grid;gap:16px">
          <div>
            <label style="display:block;margin-bottom:8px;font-weight:600">Jouw naam *</label>
            <input type="text" id="review-name" required placeholder="Voornaam" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px" />
          </div>
          <div>
            <label style="display:block;margin-bottom:8px;font-weight:600">Rating *</label>
            <div class="star-rating" style="font-size:32px;cursor:pointer">
              <span data-rating="1">‚òÜ</span>
              <span data-rating="2">‚òÜ</span>
              <span data-rating="3">‚òÜ</span>
              <span data-rating="4">‚òÜ</span>
              <span data-rating="5">‚òÜ</span>
            </div>
            <input type="hidden" id="review-rating" value="0" required />
          </div>
          <div>
            <label style="display:block;margin-bottom:8px;font-weight:600">Jouw ervaring *</label>
            <textarea id="review-text" required placeholder="Vertel ons over je ervaring met dit product..." style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;min-height:120px;font-family:inherit" maxlength="500"></textarea>
            <div style="text-align:right;color:var(--muted);font-size:12px;margin-top:4px">
              <span id="review-char-count">0</span>/500 tekens
            </div>
          </div>
          <button type="submit" class="btn primary" style="width:100%;padding:12px">
            üìù Review plaatsen
          </button>
        </form>
      </div>
    </div>
  `;

  // Star rating interaction
  const stars = modal.querySelectorAll(".star-rating span");
  const ratingInput = document.getElementById("review-rating");

  stars.forEach((star, index) => {
    star.addEventListener("click", () => {
      const rating = index + 1;
      ratingInput.value = rating;
      stars.forEach((s, i) => {
        s.textContent = i < rating ? "‚òÖ" : "‚òÜ";
      });
    });
    star.addEventListener("mouseenter", () => {
      stars.forEach((s, i) => {
        s.textContent = i <= index ? "‚òÖ" : "‚òÜ";
      });
    });
  });

  modal.querySelector(".star-rating")?.addEventListener("mouseleave", () => {
    const currentRating = parseInt(ratingInput.value, 10);
    stars.forEach((s, i) => {
      s.textContent = i < currentRating ? "‚òÖ" : "‚òÜ";
    });
  });

  // Character counter
  const textarea = document.getElementById("review-text");
  const charCount = document.getElementById("review-char-count");
  textarea?.addEventListener("input", () => {
    if (charCount) charCount.textContent = textarea.value.length;
  });

  // Form submission
  document.getElementById("review-form")?.addEventListener("submit", (e) => {
    e.preventDefault();
    submitReview(productId);
  });

  modal.classList.remove("hidden");
}

function submitReview(productId) {
  const name = document.getElementById("review-name")?.value;
  const rating = parseInt(document.getElementById("review-rating")?.value, 10);
  const text = document.getElementById("review-text")?.value;

  if (!name || rating === 0 || !text) {
    showToast("Vul alle velden in");
    return;
  }

  // Store review in localStorage
  const reviews = JSON.parse(localStorage.getItem("userReviews") || "{}");
  if (!reviews[productId]) reviews[productId] = [];

  reviews[productId].push({
    name,
    rating,
    text,
    date: new Date().toLocaleDateString("nl-NL"),
    verified: false,
  });

  localStorage.setItem("userReviews", JSON.stringify(reviews));

  showToast("Bedankt voor je review!");
  closeModal();

  // Reopen product modal to show new review
  const p = ALL.find((x) => x.id === productId);
  if (p) {
    setTimeout(() => openProductModal(p), 500);
  }
}

function getUserReviews(productId) {
  const reviews = JSON.parse(localStorage.getItem("userReviews") || "{}");
  return reviews[productId] || [];
}
